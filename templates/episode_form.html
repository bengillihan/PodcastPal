{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h2 class="mb-4">{% if episode %}Edit Episode{% else %}Add Episode{% endif %} in {{ feed.name }}</h2>
        <form method="POST">
            <div class="mb-3">
                <label for="title" class="form-label">Episode Title</label>
                <input type="text" class="form-control" id="title" name="title" value="{{ episode.title if episode else '' }}" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3" required>{{ episode.description if episode else '' }}</textarea>
            </div>
            <div class="mb-3">
                <label for="audio_url" class="form-label">Audio File URL</label>
                <input type="url" class="form-control mb-2" id="audio_url" name="audio_url" 
                       value="{{ episode.audio_url if episode else '' }}" required>
                <div class="form-text mb-2">
                    <strong>Dropbox Instructions:</strong><br>
                    1. Upload your audio file to Dropbox<br>
                    2. Create a shared link<br>
                    3. Copy the link (format: https://www.dropbox.com/s/YOUR_FILE_PATH/file.mp3?dl=0)<br>
                    <br>
                    Supported formats: MP3, WAV, M4A, OGG
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>URL that will be used in RSS feed:</strong></label>
                    <input type="text" class="form-control bg-dark text-light" id="reformattedUrl" readonly 
                           aria-label="Reformatted URL for RSS feed">
                    <div class="form-text">This URL is automatically generated and will be used in your podcast's RSS feed.</div>
                </div>
            </div>
            <div class="mb-3">
                <label for="release_date" class="form-label">Release Date and Time</label>
                <div class="input-group">
                    <input type="datetime-local" class="form-control" id="release_date" name="release_date" required>
                    <button type="button" class="btn btn-outline-secondary" id="release-today">Release Today</button>
                </div>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="is_recurring" name="is_recurring" {% if episode and episode.is_recurring %}checked{% endif %}>
                <label class="form-check-label" for="is_recurring">Recurring annually</label>
            </div>
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('feed_details', feed_id=feed.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">{% if episode %}Update{% else %}Add{% endif %} Episode</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Convert UTC to Pacific Time for display
    const convertToPacificTime = (date) => {
        // Get Pacific Time offset in minutes
        const pacificOffset = -480; // UTC-8 (in minutes)
        const localOffset = date.getTimezoneOffset();
        // Adjust the date by the difference between Pacific and local time
        return new Date(date.getTime() + (localOffset - pacificOffset) * 60000);
    };

    // Handle datetime input default value
    const now = convertToPacificTime(new Date());
    {% if episode %}
    const existingDate = convertToPacificTime(new Date('{{ episode.release_date.strftime("%Y-%m-%d %H:%M") }}'));
    const defaultDateTime = existingDate.toISOString().slice(0, 16);
    {% else %}
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const defaultDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    {% endif %}
    document.getElementById('release_date').value = defaultDateTime;

    // Handle "Release Today" button click
    document.getElementById('release-today').addEventListener('click', function() {
        const now = convertToPacificTime(new Date());
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const todayDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('release_date').value = todayDateTime;
    });

    // Handle URL reformatting
    const audioUrlInput = document.getElementById('audio_url');
    const reformattedUrlInput = document.getElementById('reformattedUrl');

    function extractGoogleDriveFileId(url) {
        const fileIdPattern = /\/file\/d\/([a-zA-Z0-9_-]+)/;
        const idPattern = /[?&]id=([a-zA-Z0-9_-]+)/;

        let match = url.match(fileIdPattern);
        if (match) return match[1];

        match = url.match(idPattern);
        if (match) return match[1];

        return null;
    }

    function reformatUrl(url) {
        if (!url) return '';

        if (url.includes('dropbox.com')) {
            let base_url = url.replace('www.dropbox.com', 'dl.dropboxusercontent.com');
            if (base_url.includes('?')) {
                const params = base_url.split('?')[1].split('&')
                    .filter(p => !p.startsWith('dl='));
                if (params.length) {
                    return `${base_url.split('?')[0]}?${params.join('&')}`;
                }
                return base_url.split('?')[0];
            }
            return base_url;
        } else if (url.includes('drive.google.com')) {
            const fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
        }
        return url;
    }

    audioUrlInput.addEventListener('input', function() {
        const url = this.value.trim();
        reformattedUrlInput.value = reformatUrl(url);
    });

    // Show initial reformatted URL if exists
    if (audioUrlInput.value) {
        reformattedUrlInput.value = reformatUrl(audioUrlInput.value.trim());
    }
});
</script>
{% endblock %}